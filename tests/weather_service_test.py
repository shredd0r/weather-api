from abc import ABC, abstractmethod
import json
import logging
import time
from types import NoneType
from typing import Generic, List, TypeVar
import unittest
from unittest.mock import MagicMock, Mock, patch
from selectolax.parser import HTMLParser

from src.models import CurrentWeatherForecast, DailyWeatherForecast, HourlyWeatherForecast, UnitType, WeatherForecastRequest
from src.weather_client import WeatherClient
from src.weather_service import IMPERIA_UNIT_TYPE, NotFoundException, WeatherService

PATH_TO_ASSETS = "./tests/assets/{file_name}"
NOT_FOUND_PAGE_FILE = "Not_found.html"
CURRENT_WEATHER_FORECAST_PAGE_FILE = "Current_weather_forecast.html"
HOURLY_WEATHER_FORECAST_PAGE_FILE = "Hourly_weather_forecast.html"
DAILY_WEATHER_FORECAST_PAGE_FILE = "Daily_weather_forecast.html"

logger = logging.getLogger("test")
weather_service = WeatherService(
    logger=logger.getChild("weather-service"),
    weather_client=WeatherClient(logger.getChild("weather-client"))
)

def get_default_request() -> WeatherForecastRequest:
    return WeatherForecastRequest(
        place_id="a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2",
        language="uk-UA",
        unit_type=UnitType.IMPERIAL)



RESPONSE_TYPE = TypeVar('RESPONSE')

class BaseWeatherForecastTestCases(unittest.TestCase, Generic[RESPONSE_TYPE], ABC):
    
    @abstractmethod
    def get_expected_response(self, request: WeatherForecastRequest) -> RESPONSE_TYPE:
        raise NotImplemented

    @abstractmethod
    def call_tested_method(self, request: WeatherForecastRequest) -> RESPONSE_TYPE:
        raise NotImplemented

    @abstractmethod
    def compare_expected_and_actual_responses(self, expected: RESPONSE_TYPE, actual: RESPONSE_TYPE):
        raise NotImplemented

    @abstractmethod
    def get_weather_forecast_page_file(self) -> str:
        raise NotImplemented
    
    def _set_html_page_to_mock_by_file_name(self, file_name: str, mock_requests: Mock):
        mock_response = MagicMock()
        with open(PATH_TO_ASSETS.format(file_name=file_name)) as file:
            mock_response.text = file.read()
            logger.info(mock_response.text)
        mock_requests.get.return_value = mock_response

    @patch("src.weather_service.requests")
    def test_server_return_not_found_page(self, mock_requests: Mock):
        self._set_html_page_to_mock_by_file_name(NOT_FOUND_PAGE_FILE, mock_requests)

        with self.assertRaises(NotFoundException) as context:
            resp = self.call_tested_method((get_default_request()))
            self.assertFalse(resp)

    @patch("src.weather_service.requests")
    def test_server_return_forecast(self, mock_requests: Mock):
        file = self.get_weather_forecast_page_file()
        self._set_html_page_to_mock_by_file_name(file, mock_requests)
        request = get_default_request()
        expected = self.get_expected_response(request)
        actual = self.call_tested_method(request)

        self.compare_expected_and_actual_responses(expected, actual)

    @patch("src.weather_service.requests")
    def test_format_correctly_url_to_server(self, mock_requests: Mock):
        return 


class CurrentWeatherForecastTests(BaseWeatherForecastTestCases[CurrentWeatherForecast]):
    def get_expected_response(self, request: WeatherForecastRequest) -> CurrentWeatherForecast:
        return CurrentWeatherForecast(
            epoch_time=int(time.time()),
            visibility=9.66,
            current_temperature=33,
            min_temperature=17,
            max_temperature=35,
            feels_like_temperature=33,
            icon_name="Mostly Clear Day",
            link="https://weather.com/{language}/weather/today/l/{place_id}?unit={unit}".format(place_id=request.place_id, language=request.language, unit=IMPERIA_UNIT_TYPE))

    def call_tested_method(self, request: WeatherForecastRequest) -> CurrentWeatherForecast:
        return weather_service.get_current_weather(request)
    
    def get_weather_forecast_page_file(self) -> str:
        return CURRENT_WEATHER_FORECAST_PAGE_FILE

    def compare_expected_and_actual_responses(self, expected: CurrentWeatherForecast, actual: CurrentWeatherForecast):
        self.assertGreaterEqual(actual.epoch_time, expected.epoch_time)
        self.assertEqual(actual.visibility, expected.visibility)
        self.assertEqual(actual.current_temperature, expected.current_temperature)
        self.assertEqual(actual.min_temperature, expected.min_temperature)
        self.assertEqual(actual.max_temperature, expected.max_temperature)
        self.assertEqual(actual.feels_like_temperature, expected.feels_like_temperature)
        self.assertEqual(actual.icon_name, expected.icon_name)
        self.assertEqual(actual.link, expected.link)

class HourlyWeatherForecastTests(BaseWeatherForecastTestCases[HourlyWeatherForecast]):
    def get_expected_response(self, request: WeatherForecastRequest) -> List[HourlyWeatherForecast]:
        json_str = """[{"epoch_time":0,"current_temperature":19,"feels_like_temperature":19,"uv_index":0.0,"probability_of_precipitation":0.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Пн-Пн-Зх","speed":4.0},"icon":"Mostly Cloudy Night","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":18,"feels_like_temperature":18,"uv_index":0.0,"probability_of_precipitation":0.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Пн-Пн-Зх","speed":4.0},"icon":"Cloudy","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":16,"feels_like_temperature":16,"uv_index":0.0,"probability_of_precipitation":0.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Пн-Пн-Зх","speed":3.0},"icon":"Mostly Cloudy Night","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":15,"feels_like_temperature":15,"uv_index":0.0,"probability_of_precipitation":1.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Пн-Пн-Зх","speed":3.0},"icon":"Partly Cloudy Night","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":14,"feels_like_temperature":14,"uv_index":0.0,"probability_of_precipitation":1.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Пн-Пн-Зх","speed":3.0},"icon":"Clear Night","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":13,"feels_like_temperature":13,"uv_index":0.0,"probability_of_precipitation":1.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Пн-Пн-Зх","speed":2.0},"icon":"Clear Night","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":12,"feels_like_temperature":12,"uv_index":0.0,"probability_of_precipitation":1.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Пн-Пн-Зх","speed":2.0},"icon":"Clear Night","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":12,"feels_like_temperature":12,"uv_index":0.0,"probability_of_precipitation":3.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Пн-Пн-Зх","speed":2.0},"icon":"Clear Night","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":12,"feels_like_temperature":12,"uv_index":0.0,"probability_of_precipitation":3.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Пн","speed":1.0},"icon":"Sunny","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":13,"feels_like_temperature":13,"uv_index":0.0,"probability_of_precipitation":2.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Пн","speed":1.0},"icon":"Sunny","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":15,"feels_like_temperature":15,"uv_index":1.0,"probability_of_precipitation":1.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Пн-Пн-Сх","speed":1.0},"icon":"Sunny","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":18,"feels_like_temperature":18,"uv_index":2.0,"probability_of_precipitation":0.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Пн-Сх","speed":1.0},"icon":"Sunny","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":20,"feels_like_temperature":20,"uv_index":3.0,"probability_of_precipitation":0.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Сх-Пн-Сх","speed":2.0},"icon":"Sunny","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":21,"feels_like_temperature":21,"uv_index":5.0,"probability_of_precipitation":0.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Сх","speed":2.0},"icon":"Partly Cloudy Day","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":22,"feels_like_temperature":22,"uv_index":6.0,"probability_of_precipitation":0.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Сх","speed":2.0},"icon":"Partly Cloudy Day","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":23,"feels_like_temperature":23,"uv_index":7.0,"probability_of_precipitation":0.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Сх-Пд-Сх","speed":3.0},"icon":"Partly Cloudy Day","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":23,"feels_like_temperature":23,"uv_index":6.0,"probability_of_precipitation":0.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Пд-Сх","speed":3.0},"icon":"Partly Cloudy Day","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":24,"feels_like_temperature":24,"uv_index":6.0,"probability_of_precipitation":0.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Пд","speed":3.0},"icon":"Partly Cloudy Day","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":24,"feels_like_temperature":24,"uv_index":5.0,"probability_of_precipitation":0.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Пд-Пд-Сх","speed":3.0},"icon":"Partly Cloudy Day","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":24,"feels_like_temperature":24,"uv_index":3.0,"probability_of_precipitation":0.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Пд-Сх","speed":3.0},"icon":"Mostly Cloudy Day","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":24,"feels_like_temperature":24,"uv_index":2.0,"probability_of_precipitation":0.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Пд-Зх","speed":3.0},"icon":"Partly Cloudy Day","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":24,"feels_like_temperature":24,"uv_index":1.0,"probability_of_precipitation":0.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Пд-Пд-Зх","speed":3.0},"icon":"Mostly Cloudy Day","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":23,"feels_like_temperature":23,"uv_index":0.0,"probability_of_precipitation":0.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Пн","speed":3.0},"icon":"Mostly Cloudy Day","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":22,"feels_like_temperature":22,"uv_index":0.0,"probability_of_precipitation":0.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Пн","speed":2.0},"icon":"Mostly Cloudy Day","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":20,"feels_like_temperature":20,"uv_index":0.0,"probability_of_precipitation":0.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Пн","speed":2.0},"icon":"Mostly Cloudy Night","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":19,"feels_like_temperature":19,"uv_index":0.0,"probability_of_precipitation":0.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Пн-Пн-Сх","speed":1.0},"icon":"Mostly Cloudy Night","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":18,"feels_like_temperature":18,"uv_index":0.0,"probability_of_precipitation":0.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Пн-Сх","speed":1.0},"icon":"Mostly Cloudy Night","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":17,"feels_like_temperature":17,"uv_index":0.0,"probability_of_precipitation":0.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Пн-Сх","speed":1.0},"icon":"Mostly Cloudy Night","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":16,"feels_like_temperature":16,"uv_index":0.0,"probability_of_precipitation":0.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Сх-Пн-Сх","speed":2.0},"icon":"Partly Cloudy Night","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":16,"feels_like_temperature":16,"uv_index":0.0,"probability_of_precipitation":0.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Сх-Пн-Сх","speed":1.0},"icon":"Mostly Cloudy Night","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":15,"feels_like_temperature":15,"uv_index":0.0,"probability_of_precipitation":0.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Сх-Пн-Сх","speed":1.0},"icon":"Partly Cloudy Night","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":15,"feels_like_temperature":15,"uv_index":0.0,"probability_of_precipitation":0.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Сх","speed":1.0},"icon":"Partly Cloudy Night","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":15,"feels_like_temperature":15,"uv_index":0.0,"probability_of_precipitation":0.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Сх","speed":1.0},"icon":"Partly Cloudy Day","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":16,"feels_like_temperature":16,"uv_index":0.0,"probability_of_precipitation":0.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Сх-Пд-Сх","speed":1.0},"icon":"Partly Cloudy Day","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":17,"feels_like_temperature":17,"uv_index":1.0,"probability_of_precipitation":0.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Пд-Пд-Сх","speed":1.0},"icon":"Mostly Cloudy Day","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":18,"feels_like_temperature":18,"uv_index":1.0,"probability_of_precipitation":0.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Пд-Пд-Зх","speed":2.0},"icon":"Cloudy","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":20,"feels_like_temperature":20,"uv_index":1.0,"probability_of_precipitation":5.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Зх-Пд-Зх","speed":3.0},"icon":"Cloudy","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":20,"feels_like_temperature":20,"uv_index":2.0,"probability_of_precipitation":6.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Зх","speed":4.0},"icon":"Cloudy","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":21,"feels_like_temperature":21,"uv_index":3.0,"probability_of_precipitation":10.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Зх","speed":5.0},"icon":"Cloudy","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":21,"feels_like_temperature":21,"uv_index":3.0,"probability_of_precipitation":13.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Зх","speed":6.0},"icon":"Cloudy","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":21,"feels_like_temperature":21,"uv_index":3.0,"probability_of_precipitation":12.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Зх","speed":7.0},"icon":"Cloudy","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":21,"feels_like_temperature":21,"uv_index":4.0,"probability_of_precipitation":7.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Зх","speed":7.0},"icon":"Cloudy","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":21,"feels_like_temperature":21,"uv_index":4.0,"probability_of_precipitation":14.0,"precipitation_type":"1","amount_of_precipitation":0.0,"wind":{"direction":"Зх","speed":8.0},"icon":"Mostly Cloudy Day","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":21,"feels_like_temperature":21,"uv_index":3.0,"probability_of_precipitation":37.0,"precipitation_type":"1","amount_of_precipitation":0.25,"wind":{"direction":"Зх","speed":8.0},"icon":"Showers","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":21,"feels_like_temperature":21,"uv_index":2.0,"probability_of_precipitation":33.0,"precipitation_type":"1","amount_of_precipitation":0.32,"wind":{"direction":"Зх","speed":8.0},"icon":"Showers","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":21,"feels_like_temperature":21,"uv_index":1.0,"probability_of_precipitation":40.0,"precipitation_type":"1","amount_of_precipitation":0.33,"wind":{"direction":"Зх","speed":8.0},"icon":"Showers","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":19,"feels_like_temperature":19,"uv_index":0.0,"probability_of_precipitation":37.0,"precipitation_type":"1","amount_of_precipitation":0.29,"wind":{"direction":"Зх-Пн-Зх","speed":7.0},"icon":"Showers","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":0,"current_temperature":18,"feels_like_temperature":18,"uv_index":0.0,"probability_of_precipitation":31.0,"precipitation_type":"1","amount_of_precipitation":0.24,"wind":{"direction":"Зх","speed":6.0},"icon":"Showers","link":"https://weather.com/uk-UA/weather/hourbyhour/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"}]"""
        return [
                HourlyWeatherForecast.model_validate(item) for item in json.loads(json_str)
        ]

    def call_tested_method(self, request: WeatherForecastRequest) -> List[HourlyWeatherForecast]:
        return weather_service.get_hourly_weather(request)

    def get_weather_forecast_page_file(self) -> str:
        return HOURLY_WEATHER_FORECAST_PAGE_FILE
    
    def compare_expected_and_actual_responses(self, expected: List[HourlyWeatherForecast], actual: List[HourlyWeatherForecast]):
        self.assertEqual(actual, expected)

class DailyWeatherForecastTests(BaseWeatherForecastTestCases[DailyWeatherForecast]):
    def get_expected_response(self, request: WeatherForecastRequest) -> List[DailyWeatherForecast]:
        json_str = """[{"epoch_time":1750422480000,"day":null,"night":{"temperature":10,"humidity":69.0,"wind":{"direction":"Зх","speed":20.0},"rise_time":3300,"set_time":53160,"probability_of_precipitation":11.0,"precipitation_type":"1","icon_name":"Partly Cloudy Night"},"link":"https://weather.com/uk-UA/weather/tenday/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":1750422480000,"day":{"temperature":20,"humidity":61.0,"wind":{"direction":"Зх-Пн-Зх","speed":10.0},"rise_time":15960,"set_time":74880,"probability_of_precipitation":36.0,"precipitation_type":"1","icon_name":"Scattered Showers Day"},"night":{"temperature":12,"humidity":86.0,"wind":{"direction":"Пн-Зх","speed":8.0},"rise_time":15960,"set_time":74880,"probability_of_precipitation":24.0,"precipitation_type":"1","icon_name":"Partly Cloudy Night"},"link":"https://weather.com/uk-UA/weather/tenday/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":1750422566400,"day":{"temperature":23,"humidity":53.0,"wind":{"direction":"Зх","speed":10.0},"rise_time":15960,"set_time":74880,"probability_of_precipitation":24.0,"precipitation_type":"1","icon_name":"Cloudy"},"night":{"temperature":12,"humidity":85.0,"wind":{"direction":"Зх-Пд-Зх","speed":7.0},"rise_time":15960,"set_time":74880,"probability_of_precipitation":69.0,"precipitation_type":"1","icon_name":"Showers"},"link":"https://weather.com/uk-UA/weather/tenday/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":1750422652800,"day":{"temperature":19,"humidity":70.0,"wind":{"direction":"Пн-Зх","speed":12.0},"rise_time":15960,"set_time":74880,"probability_of_precipitation":81.0,"precipitation_type":"1","icon_name":"Thunderstorms"},"night":{"temperature":11,"humidity":81.0,"wind":{"direction":"Пн-Пн-Зх","speed":9.0},"rise_time":15960,"set_time":74880,"probability_of_precipitation":8.0,"precipitation_type":"1","icon_name":"Mostly Clear Night"},"link":"https://weather.com/uk-UA/weather/tenday/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":1750422739200,"day":{"temperature":25,"humidity":55.0,"wind":{"direction":"Пд-Зх","speed":8.0},"rise_time":15960,"set_time":74880,"probability_of_precipitation":21.0,"precipitation_type":"1","icon_name":"Partly Cloudy Day"},"night":{"temperature":15,"humidity":69.0,"wind":{"direction":"Пд-Пд-Зх","speed":7.0},"rise_time":15960,"set_time":74880,"probability_of_precipitation":39.0,"precipitation_type":"1","icon_name":"Showers"},"link":"https://weather.com/uk-UA/weather/tenday/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":1750422825600,"day":{"temperature":24,"humidity":59.0,"wind":{"direction":"Зх","speed":11.0},"rise_time":16020,"set_time":74880,"probability_of_precipitation":33.0,"precipitation_type":"1","icon_name":"Scattered Showers Day"},"night":{"temperature":15,"humidity":71.0,"wind":{"direction":"Зх-Пд-Зх","speed":8.0},"rise_time":16020,"set_time":74880,"probability_of_precipitation":22.0,"precipitation_type":"1","icon_name":"Partly Cloudy Night"},"link":"https://weather.com/uk-UA/weather/tenday/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":1750422912000,"day":{"temperature":24,"humidity":58.0,"wind":{"direction":"Зх","speed":14.0},"rise_time":16020,"set_time":74880,"probability_of_precipitation":24.0,"precipitation_type":"1","icon_name":"Partly Cloudy Day"},"night":{"temperature":14,"humidity":72.0,"wind":{"direction":"Зх-Пн-Зх","speed":9.0},"rise_time":16020,"set_time":74880,"probability_of_precipitation":8.0,"precipitation_type":"1","icon_name":"Mostly Clear Night"},"link":"https://weather.com/uk-UA/weather/tenday/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":1750422998400,"day":{"temperature":25,"humidity":52.0,"wind":{"direction":"Зх-Пн-Зх","speed":12.0},"rise_time":16080,"set_time":74880,"probability_of_precipitation":24.0,"precipitation_type":"1","icon_name":"Partly Cloudy Day"},"night":{"temperature":16,"humidity":67.0,"wind":{"direction":"Зх","speed":9.0},"rise_time":16080,"set_time":74880,"probability_of_precipitation":41.0,"precipitation_type":"1","icon_name":"Scattered Showers Night"},"link":"https://weather.com/uk-UA/weather/tenday/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":1750423084800,"day":{"temperature":27,"humidity":52.0,"wind":{"direction":"Зх-Пн-Зх","speed":14.0},"rise_time":16080,"set_time":74880,"probability_of_precipitation":22.0,"precipitation_type":"1","icon_name":"Partly Cloudy Day"},"night":{"temperature":16,"humidity":65.0,"wind":{"direction":"Зх","speed":10.0},"rise_time":16080,"set_time":74880,"probability_of_precipitation":35.0,"precipitation_type":"1","icon_name":"Scattered Showers Night"},"link":"https://weather.com/uk-UA/weather/tenday/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":1750423171200,"day":{"temperature":27,"humidity":50.0,"wind":{"direction":"Зх-Пн-Зх","speed":13.0},"rise_time":16140,"set_time":74880,"probability_of_precipitation":24.0,"precipitation_type":"1","icon_name":"Partly Cloudy Day"},"night":{"temperature":15,"humidity":63.0,"wind":{"direction":"Зх-Пн-Зх","speed":10.0},"rise_time":16140,"set_time":74880,"probability_of_precipitation":19.0,"precipitation_type":"1","icon_name":"Partly Cloudy Night"},"link":"https://weather.com/uk-UA/weather/tenday/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":1750423257600,"day":{"temperature":26,"humidity":48.0,"wind":{"direction":"Зх-Пн-Зх","speed":13.0},"rise_time":16140,"set_time":74880,"probability_of_precipitation":20.0,"precipitation_type":"1","icon_name":"Partly Cloudy Day"},"night":{"temperature":14,"humidity":64.0,"wind":{"direction":"Зх-Пн-Зх","speed":9.0},"rise_time":16140,"set_time":74880,"probability_of_precipitation":4.0,"precipitation_type":"1","icon_name":"Partly Cloudy Night"},"link":"https://weather.com/uk-UA/weather/tenday/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":1750423344000,"day":{"temperature":26,"humidity":45.0,"wind":{"direction":"Зх-Пн-Зх","speed":12.0},"rise_time":16200,"set_time":74820,"probability_of_precipitation":5.0,"precipitation_type":"1","icon_name":"Mostly Clear Day"},"night":{"temperature":14,"humidity":64.0,"wind":{"direction":"Пн-Зх","speed":9.0},"rise_time":16200,"set_time":74820,"probability_of_precipitation":3.0,"precipitation_type":"1","icon_name":"Mostly Clear Night"},"link":"https://weather.com/uk-UA/weather/tenday/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":1750423430400,"day":{"temperature":26,"humidity":47.0,"wind":{"direction":"Пн-Зх","speed":11.0},"rise_time":16260,"set_time":74820,"probability_of_precipitation":7.0,"precipitation_type":"1","icon_name":"Mostly Clear Day"},"night":{"temperature":15,"humidity":62.0,"wind":{"direction":"Зх-Пн-Зх","speed":8.0},"rise_time":16260,"set_time":74820,"probability_of_precipitation":7.0,"precipitation_type":"1","icon_name":"Partly Cloudy Night"},"link":"https://weather.com/uk-UA/weather/tenday/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":1750423516800,"day":{"temperature":26,"humidity":47.0,"wind":{"direction":"Зх-Пн-Зх","speed":12.0},"rise_time":16260,"set_time":74820,"probability_of_precipitation":7.0,"precipitation_type":"1","icon_name":"Mostly Clear Day"},"night":{"temperature":15,"humidity":63.0,"wind":{"direction":"Зх-Пн-Зх","speed":9.0},"rise_time":16260,"set_time":74820,"probability_of_precipitation":2.0,"precipitation_type":"1","icon_name":"Partly Cloudy Night"},"link":"https://weather.com/uk-UA/weather/tenday/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"},{"epoch_time":1750423603200,"day":{"temperature":27,"humidity":45.0,"wind":{"direction":"Зх-Пн-Зх","speed":11.0},"rise_time":16320,"set_time":74760,"probability_of_precipitation":8.0,"precipitation_type":"1","icon_name":"Mostly Clear Day"},"night":{"temperature":16,"humidity":61.0,"wind":{"direction":"Зх-Пн-Зх","speed":8.0},"rise_time":16320,"set_time":74760,"probability_of_precipitation":8.0,"precipitation_type":"1","icon_name":"Partly Cloudy Night"},"link":"https://weather.com/uk-UA/weather/tenday/l/a3fc3a9546b3303604bb2e67c47280cd13107b83a2da060d38c4e0941f3105d2?unit=e"}]"""
        return [
                DailyWeatherForecast.model_validate(item) for item in json.loads(json_str)
        ]
    
    def call_tested_method(self, request: WeatherForecastRequest) -> List[DailyWeatherForecast]:
        return weather_service.get_daily_weather(request)
    
    def get_weather_forecast_page_file(self) -> str:
        return DAILY_WEATHER_FORECAST_PAGE_FILE
    
    def compare_expected_and_actual_responses(self, expected: List[DailyWeatherForecast], actual: List[DailyWeatherForecast]):
        self.assertEqual(actual, expected)